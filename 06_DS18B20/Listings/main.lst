C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: E:\MDK\install\Core\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <reg52.h>
   2          #include <intrins.h>
   3          #define uchar unsigned char
   4          #define uint unsigned int
   5          sbit HC138_A = P2^5;
   6          sbit HC138_B = P2^6;
   7          sbit HC138_C = P2^7;
   8          sbit DB = P1^4;
   9          uchar TPH = 0;
  10          uchar TPL = 0;
  11          uint temp = 0;
  12          
  13          // 0~9、0.~9.、°、C
  14          uchar code tab[] = {0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0x40,0x79,0x24,0x30,0x19,0x12,0x12,0
             -x78,0x00,0x12,0x9C,0xC6};
  15          uchar code select[] = {0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80};
  16          
  17          /**********************************************************
  18          *  函数名称：500us延时
  19          *  修改日期：2019-12-2
  20          *  修改人：ZhangHJ
  21          *  说明：由STC-ISP软件自动生成
  22          ***********************************************************/
  23          void Delay500us()               //@11.0592MHz
  24          {
  25   1              unsigned char i, j;
  26   1              _nop_();
  27   1              _nop_();
  28   1              i = 6;
  29   1              j = 93;
  30   1              do
  31   1              {
  32   2                      while (--j);
  33   2              } while (--i);
  34   1      }
  35          
  36          
  37          
  38          /**********************************************************
  39          *  函数名称：2us延时
  40          *  修改日期：2019-12-2
  41          *  修改人：ZhangHJ
  42          *  说明：由STC-ISP软件自动生成
  43          ***********************************************************/
  44          void Delay2us()         //@11.0592MHz
  45          {
  46   1              unsigned char i;
  47   1      
  48   1              i = 3;
  49   1              while (--i);
  50   1      }
  51          
  52          
  53          
C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 2   

  54          /**********************************************************
  55          *  函数名称：600us延时
  56          *  修改日期：2019-12-2
  57          *  修改人：ZhangHJ
  58          *  说明：由STC-ISP软件自动生成
  59          ***********************************************************/
  60          void Delay600us()               //@11.0592MHz
  61          {
  62   1              unsigned char i, j;
  63   1              i = 7;
  64   1              j = 113;
  65   1              do
  66   1              {
  67   2                      while (--j);
  68   2              } while (--i);
  69   1      }
  70          
  71          
  72          
  73          /**********************************************************
  74          *  函数名称：100us延时
  75          *  修改日期：2019-12-2
  76          *  修改人：ZhangHJ
  77          *  说明：由STC-ISP软件自动生成
  78          ***********************************************************/
  79          void Delay10us()                //@11.0592MHz
  80          {
  81   1              unsigned char i;
  82   1      
  83   1              _nop_();
  84   1              i = 25;
  85   1              while (--i);
  86   1      }
  87          
  88          
  89          
  90          /**********************************************************
  91          *  函数名称：420us延时
  92          *  修改日期：2019-12-2
  93          *  修改人：ZhangHJ
  94          *  说明：由STC-ISP软件自动生成
  95          ***********************************************************/
  96          void Delay420us()               //@11.0592MHz
  97          {
  98   1              unsigned char i, j;
  99   1      
 100   1              _nop_();
 101   1              i = 5;
 102   1              j = 129;
 103   1              do
 104   1              {
 105   2                      while (--j);
 106   2              } while (--i);
 107   1      }
 108          
 109          
 110          
 111          /**********************************************************
 112          *  函数名称：60us延时
 113          *  修改日期：2019-12-2
 114          *  修改人：ZhangHJ
 115          *  说明：由STC-ISP软件自动生成
C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 3   

 116          ***********************************************************/
 117          void Delay60us()                //@11.0592MHz
 118          {
 119   1              unsigned char i, j;
 120   1      
 121   1              i = 1;
 122   1              j = 162;
 123   1              do
 124   1              {
 125   2                      while (--j);
 126   2              } while (--i);
 127   1      }
 128          
 129          
 130          
 131          /**********************************************************
 132          *  函数名称：480us延时
 133          *  修改日期：2019-12-2
 134          *  修改人：ZhangHJ
 135          *  说明：由STC-ISP软件自动生成
 136          ***********************************************************/
 137          void Delay480us()               //@11.0592MHz
 138          {
 139   1              unsigned char i, j;
 140   1      
 141   1              i = 6;
 142   1              j = 38;
 143   1              do
 144   1              {
 145   2                      while (--j);
 146   2              } while (--i);
 147   1      }
 148          
 149          
 150          
 151          /**********************************************************
 152          *  函数名称：50us延时
 153          *  修改日期：2019-12-2
 154          *  修改人：ZhangHJ
 155          *  说明：由STC-ISP软件自动生成
 156          ***********************************************************/
 157          void Delay50us()                //@11.0592MHz
 158          {
 159   1              unsigned char i, j;
 160   1              _nop_();
 161   1              i = 1;
 162   1              j = 134;
 163   1              do
 164   1              {
 165   2                      while (--j);
 166   2              } while (--i);
 167   1      }
 168          
 169          
 170          
 171          /**********************************************************
 172          *  函数名称：系统初始化
 173          *  修改日期：2019-12-2
 174          *  修改人：ZhangHJ
 175          *  说明：关闭蜂鸣器、继电器和LED
 176          ***********************************************************/
 177          void System_Init()
C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 4   

 178          {
 179   1              HC138_A = 1;
 180   1              HC138_B = 0;
 181   1              HC138_C = 1;
 182   1              WR = 0;
 183   1              P0 = 0x00;
 184   1              HC138_A = 0;
 185   1              HC138_B = 0;
 186   1              HC138_C = 1;
 187   1              WR = 0;
 188   1              P0 = 0xFF;
 189   1      }
 190          
 191          
 192          
 193          /**********************************************************
 194          *  函数名称：LED显示函数
 195          *  修改日期：2019-12-2
 196          *  修改人：ZhangHJ
 197          *  说明：用于显示温度数据
 198          *                1. 参数selection表示数码管位选
 199          *                2. 参数segment表示数码管段选
 200          ***********************************************************/
 201          void LED_Display(uchar selection, uchar segment)
 202          {
 203   1              HC138_A = 0;
 204   1              HC138_B = 1;
 205   1              HC138_C = 1;
 206   1              WR = 0;
 207   1              P0 = 0x00;
 208   1              HC138_A = 1;
 209   1              HC138_B = 1;
 210   1              HC138_C = 1;
 211   1              WR = 0;
 212   1              P0 = tab[segment];
 213   1              HC138_A = 0;
 214   1              HC138_B = 1;
 215   1              HC138_C = 1;
 216   1              WR = 0;
 217   1              P0 = select[selection];
 218   1              Delay600us();
 219   1              Delay500us();
 220   1              HC138_A = 1;
 221   1              HC138_B = 1;
 222   1              HC138_C = 1;
 223   1              WR = 0;
 224   1              P0 = 0xFF;
 225   1      }
 226          
 227          
 228          
 229          /**********************************************************
 230          *  函数名称：DS18B20初始化
 231          *  修改日期：2019-12-2
 232          *  修改人：ZhangHJ
 233          *  说明：用于初始化DS18B20温度传感器
 234          *                1. Master先将总线拉低480~960us，然后释放总线
 235          *                2. DS18B20等待15~60us之后，将总线拉低60~240us
 236          ***********************************************************/
 237          void DS18B20_Init()
 238          {
 239   1              CY = 1;
C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 5   

 240   1              while(CY)
 241   1              {
 242   2                      DB = 0;
 243   2                      Delay480us();
 244   2                      DB = 1;
 245   2                      Delay60us();
 246   2                      CY = DB;
 247   2                      Delay420us();
 248   2              }
 249   1      }
 250          
 251          
 252          
 253          /**********************************************************
 254          *  函数名称：DS18B20写1Byte数据
 255          *  修改日期：2019-12-2
 256          *  修改人：ZhangHJ
 257          *  说明：用于向DS18B20写1Byte数据
 258          *                1. 写0或写1之前，Master都会把总线拉低
 259          *                2. 写1时，Master会在15us之内释放总线; 写0时，Master会维持总线低的状态
 260          *                3. DS18B20会在15~60us时隙内采集数据
 261          ***********************************************************/
 262          void DS18B20_Write_Byte(uchar byte_data)
 263          {
 264   1              uchar i;
 265   1              for(i=0; i<8; i++)
 266   1              {
 267   2                      DB = 0;
 268   2                      Delay10us();
 269   2                      DB = byte_data & 0x01;          // 0000000x
 270   2                      Delay60us();
 271   2                      DB = 1;
 272   2                      Delay10us();
 273   2                      byte_data >>= 1;
 274   2              }
 275   1      }
 276          
 277          
 278          
 279          /**********************************************************
 280          *  函数名称：DS18B20读1Byte数据
 281          *  修改日期：2019-12-2
 282          *  修改人：ZhangHJ
 283          *  说明：用于从DS18B20读1Byte数据
 284          *                1. 对于读时隙，开始之前Master都要先拉低总线至少1us
 285          *                2. 18B20如果维持总线低状态，Master就会读到0; 18B20如果释放总线，由于上拉电阻作用，Master就会读到1
 286          *                3. Master会在15us的末位读入数据，整个读时隙维持60us左右
 287          ***********************************************************/
 288          uchar DS18B20_Read_Byte()
 289          {
 290   1              uchar i;
 291   1              uchar byte_data = 0;
 292   1              for(i=0; i<8; i++)
 293   1              {
 294   2                      byte_data >>= 1;
 295   2                      DB = 0;
 296   2                      Delay2us();
 297   2                      DB = 1;
 298   2                      Delay10us();
 299   2                      if(DB)
 300   2                      byte_data |= 0x80;
 301   2                      Delay50us();
C51 COMPILER V9.57.0.0   MAIN                                                              12/02/2019 09:30:59 PAGE 6   

 302   2              }
 303   1              return byte_data;
 304   1      }
 305          
 306          
 307          
 308          /**********************************************************
 309          *  函数名称：DS18B20读取温度数据
 310          *  修改日期：2019-12-2
 311          *  修改人：ZhangHJ
 312          *  说明：用于从DS18B20获取温度数据
 313          *                1. 初始化-->ROM命令-->控制命令
 314          *                2. 初始化-->跳过ROM-->温度转换命令
 315          *                3. 初始化-->跳过ROM-->读取温度命令
 316          *                4. 两次温度读取,然后处理数据
 317          ***********************************************************/
 318          void DS18B20_FUNCTION()
 319          {
 320   1              DS18B20_Init();
 321   1              DS18B20_Write_Byte(0xCC);       // Skip ROM
 322   1              DS18B20_Write_Byte(0x44);       // Convert T
 323   1              while(!DB);
 324   1              DS18B20_Init();
 325   1              DS18B20_Write_Byte(0xCC);       // Skip ROM
 326   1              DS18B20_Write_Byte(0xBE);       // Read Scratchpad
 327   1              TPL = DS18B20_Read_Byte();
 328   1              TPH = DS18B20_Read_Byte();
 329   1              temp = ((TPH << 8) | TPL) * 6.25;
 330   1      }
 331          
 332          
 333          
 334          // 主函数功能：DS18B20显示温度数值
 335          void main()
 336          {
 337   1              System_Init();
 338   1              while(1)
 339   1              {
 340   2                      DS18B20_FUNCTION();
 341   2                      Delay500us();
 342   2                      {
 343   3                              LED_Display(2, temp/1000);
 344   3                              LED_Display(3, (temp/100)%10+10);
 345   3                              LED_Display(4, (temp%100)/10);
 346   3                              LED_Display(5, temp%10);
 347   3                              LED_Display(6, 20);
 348   3                              LED_Display(7, 21);
 349   3                      }
 350   2              }
 351   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    418    ----
   CONSTANT SIZE    =     30    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
